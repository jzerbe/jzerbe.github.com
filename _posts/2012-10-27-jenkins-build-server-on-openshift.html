---
layout: post
title: Jenkins build server on OpenShift
tags:
- Jenkins
- build
- OpenShift
status: publish
type: post
published: true
meta:
_edit_last: "1"
---
You should sign-up for an OpenShift account, just to make use of being able
to spin-up your own <a href="http://jenkins-ci.org/">Jenkins-CI</a> build
server for FREE.
Granted, connecting to external SSH backed GIT repositories is not possible,
due to the inability to add to the <code>known_hosts</code> file,
but there are ways around this.
I have made use of bitbucket&#39;s &quot;get more users&quot; deal when you
invite some people and they sign-up: I created a second account with a dummy
password for use with connecting over HTTPS, as I do not want to divulge
my actual account password in the Jenkins config.<br />
<br />

<strong>auto-install Jenkins</strong>
The OpenShift application maintenance panel provides an option to create a
Jenkins build server &quot;gear&quot; when digging around in your existing
application settings. The &quot;Enable Jenkins builds&quot; button is your
friend.<br />
<br />

<strong>with the OpenShift app&#39;s internal GIT repo</strong><br />
When you log in for the first time to your new Jenkins gear, you should see a
<i>somethingsomething</i>-build job already created. If you are using the
GIT repo associated with your application and do not touch any configuration
files, then everything should work out of the box. However, I wanted to be
be able to build any type of project.<br />
<br />

<strong>break the sandbox - build tools</strong>
<ol>
    <li>
        Manage Jenkins -> Configuration
        <ul>
            <li># of executors = 1</li>
            <li>Usage = Utilize this slave as much as possible</li>
        </ul>
    </li>
    <li>
        The Git plugin and binaries are already installed, but you will need
        to correctly configure them. I named mine <code>git 1.7.1</code> and
        had to set the path <code>/usr/bin/git</code>. May want to confirm
        with a <code>git --version</code> and <code>which git</code>.
    </li>
    <li>
        The Maven plugin and binaries are also already installed, one may need
        to set up the naming - <code>Maven 3.0.3</code>, with
        MAVEN_HOME <code>/usr/bin</code>. On OpenShift, the only option for
        Maven repository information will be to use the
        &quot;Local to workspace&quot; option; nothing else is writable.
    </li>
    <li>
        Download and extract ANT from one of the
        <a href="http://ant.apache.org/bindownload.cgi">binary archives</a>.
        Install the Jenkins plugin. Configure with a name and the full path
        to the root directory ANT was extracted into. On my gear, that was
        <code>/var/lib/stickshift/[...]/app-root/data/apache-ant-1.8.4</code>.
    </li>
</ol>
<br />

<strong>break the sandbox - config with 3rd party repo</strong>
<ol>
    <li>
        Create a <b>New Job</b> copied from the existing
        <i>somethingsomething</i>-build job. I called mine
        <i>somethingsomething</i>-custom.
    </li>
    <li>
        May want to do something about: <i>Discard Old Builds</i>
    </li>
    <li>
        Source Code Management -> Git
        <ul>
            <li>
                URL of repository =
                <code>https://[username]:[password]@bitbucket.org/you/cool_repo.git</code>
            </li>
            <li>
                Branch Specifier = origin/master
            </li>
        </ul>
    </li>
    <li>
        Build Triggers -> Trigger builds remotely -> Authentication Token.
        Input a long-ish string that is secret. Then in the <i>Services</i>
        section of <code>cool_repo</code>: <code>Token</code> would be set to
        said long-ish string, <code>Project name</code> =
        <i>somethingsomething</i>-custom, <code>Endpoint</code> =
        <code>https://[user]:[API token]@jenkins-[namespace].rhcloud.com</code>.
    </li>
</ol>
<br />

<strong>split up the Build steps</strong><br />
All WARs build by ANT get put into <code>deployments</code> directory and
pushed onto OpenShift gear for production use. You will need to add the
public key version of the <code>jenkins_id_rsa</code> SSH key to your OpenShift
account&#39;s list of trusted keys.<br />
<blockquote>
    <strong>ssh-wrapper script</strong>
    <code>
        #!/bin/bash<br />
        <br />
        ID_RSA="$OPENSHIFT_DATA_DIR/.ssh/jenkins_id_rsa"<br />
        <br />
        ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i $ID_RSA $1 $2<br />
    </code>
</blockquote>
<br />
<ol>
    <li>
        <b>Execute shell</b>
        <blockquote>
            <code>
                # Build setup and run user pre_build<br />
                . ci_build.sh<br />
                <br />
                if [ -e ${OPENSHIFT_REPO_DIR}.openshift/markers/java7 ];<br />
                then<br />
                &nbsp;&nbsp;&nbsp;&nbsp;export JAVA_HOME=/etc/alternatives/java_sdk_1.7.0<br />
                else<br />
                &nbsp;&nbsp;&nbsp;&nbsp;export JAVA_HOME=/etc/alternatives/java_sdk_1.6.0<br />
                fi<br />
            </code>
        </blockquote>
    </li>
    <li>
        <b>Invoke Ant</b><br />
        Ant 1.X.X, your-build-target
    </li>
    <li>
        <b>Execute shell</b>
        <blockquote>
            <code>
                source /usr/libexec/stickshift/cartridges/abstract/info/lib/jenkins_util<br />
                <br />
                # set $GIT_SSH wrapper script and backup for later<br />
                GIT_SSH_BAK=$GIT_SSH<br />
                GIT_SSH=$OPENSHIFT_DATA_DIR/ssh-wrapper<br />
                <br />
                # Stop app<br />
                $GIT_SSH [username]@somethingsomething-[namespace].rhcloud.com 'ctl_all stop'<br />
                <br />
                # Push content back to application<br />
                GIT_SSH=$GIT_SSH_BAK<br />
                rsync --delete-after -az -e 'ssh -o UserKnownHostsFile=/dev/null
                -o StrictHostKeyChecking=no
                -i /var/lib/stickshift/[...]/app-root/data/.ssh/jenkins_id_rsa'
                --exclude='*.deployed' --exclude='*.deploying' --exclude='*.isundeploying'
                $WORKSPACE/deployments/.
                [username]@somethingsomething-[namespace].rhcloud.com:~/app-root/repo/deployments/<br />
                <br />
                # Configure / start app<br />
                GIT_SSH=$OPENSHIFT_DATA_DIR/ssh-wrapper<br />
                $GIT_SSH [username]@somethingsomething-[namespace].rhcloud.com deploy.sh<br />
                <br />
                jenkins_start_app [username]@somethingsomething-[namespace].rhcloud.com<br />
                <br />
                $GIT_SSH [username]@somethingsomething-[namespace].rhcloud.com post_deploy.sh<br />
            </code>
        </blockquote>
    </li>
</ol>
<br />
