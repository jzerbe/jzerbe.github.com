---
layout: post
title: OpenWRT kamikaze with a HE IPv6 tunnel + LAN
tags:
- Internet
- IPv4
- IPv6
- Linux
- OpenWRT
status: publish
type: post
published: true
meta:
_edit_last: "1"
---
I finally took the time to add IPv6 support to my LAN this weekend. Still have a long way to go: need to add
AAAA records to my LAN DNS, static IPv6 host allocations, DHCPv6, etc. I ended with the desired initial rollout:
all the dual-stacked machines on my LAN getting allocated globally routable IPv6 addresses.<br />
<br />
Much of this is taken from the great article on OpenWRT's wiki: <a href="http://wiki.openwrt.org/doc/howto/ipv6">IPv6 HowTo on Backfire and later</a>.
I made some specific modifications for <a href="http://www.tunnelbroker.net/">Hurricane Electric's free IPv6 tunnel broker service</a>.
This assumes you have an OpenWRT install with SSH access and that you already have an account with HE's tunnelbroker service. I did
this on my Actiontec GT701-WG, which cannot handle OpenWRT Backfire, hence the hackish version for Kamikaze (8.09.2). On my specific
install, I also had to stop the cron, http, and ddns services to have a comfortable amount of RAM to work with during the install.
<blockquote>To use IPv6, we need the following modules:
    <ul>
        <li>IPv6 kernel module (always)</li>
        <li>IPv6 routing software (always, to configure IPv6 routing)</li>
        <li>ip6tables kernel modules (optional, if you need an IPv6 firewall)</li>
        <li>ip6tables command-line tool (optional, to configure the IPv6 firewall)</li>
    </ul>
    <code>opkg install kmod-ipv6 radvd ip kmod-ip6tables ip6tables</code></blockquote>
You are also going to want: <code>opkg install 6scripts 6tunnel</code>.<br />
<br />
First configure your firewall to allow ICMP pings to the router. This is a security risk, but if you intend to
dynamically update your IPv4 endpoint address with HE's automated method, you are going to need to allow pings to
your OpenWRT device. Insert the following into <code>/etc/config/firewall</code>.
<blockquote><code># needed for Hurricane Electric IPv6 ping probes<br />
        config rule<br />
        option _name    ping<br />
        option src      wan<br />
        option proto    ICMP<br />
        option target   ACCEPT</code></blockquote>
Next let's configure the <code>/etc/firewall.user</code> script to auto-configure ip6tables for wan/br-lan devices on
start/restart/stop. [<a href="https://docs.google.com/file/d/0B0yT30uCaFvvUW0tTlQ0NDlnbEE/edit?pli=1">firewall.user script</a>]<br />
<br />
Now to tie your tunnel and LAN together (such that your LAN obtains globally routable IPv6 addresses), you are going to need to
get at your <a href="http://wiki.openwrt.org/doc/uci/radvd">Router Advertisement (radvd) configuration</a> -
<code>/etc/conf/radvd</code> - [<a href="https://docs.google.com/file/d/0B0yT30uCaFvvVVVleV8zaEpQZkk/edit?pli=1">radvd conf file</a>].
Be sure to enable radvd to start on system startup: <code>/etc/init.d/radvd enable</code>.<br />
<br />
<strong>UPDATE February 10</strong>: You are going to need to restart radvd manually each time you bring your
IPv6 tunnel up or down, so that radvd knows to broadcast either a link-local subnet or the global routed IPv6
tunnel allocated subnet.<br />
<br />
Finally let's configure the tunnel itself. Kind of Quentin Tarantino'd that didn't I? Anyways ...<br />
Open up the 6tunnel config file - <code>vi /etc/config/6tunnel</code> - and take a look inside. In the end you are going to want it to look like this:
<blockquote><code>config 6tunnel<br />
        option tnlifname        'he-ipv6'<br />
        option remoteip4        '209.51.181.2'<br />
        #option localip4         ''<br />
        option localip6         '2001:470:xxxx:xxx::2/64'<br />
        option remoteip6        '2001:470:xxxx:xxx::1/64'<br />
        option prefix           '2001:470:xxxx:xxx::/64'<br />
        option passmd5          'md5 hash of your tunnelbroker password'<br />
        option userid           'UserID found on the main.php page'<br />
        option tunnelid         'tunnel id number'
    </code></blockquote>
First pop open your browser to the tunnelbroker.net page "Tunnel Details": remoteip4 = "Server IPv4 address" on
said page, localip6 = "Client IPv6 address", remoteip6 = "Server IPv6 address", prefix = "Routed /64" or
"Routed /48" if you need something that big. localip4 will be auto-detected the customized 6tunnel init.d
script, and thus can be commented out/left blank/doesn't matter.<br />
<br />
The init.d file for 6tunnel [<a href="https://docs.google.com/file/d/0B0yT30uCaFvvck54ZGFIRHN5TG8/edit?pli=1">6tunnel init script</a>]
is an amalgamation of the original init script, linux-route-2 commands as suggested by HE, and inspirations from
<a href="https://forum.openwrt.org/viewtopic.php?pid=111999#p111999">andyballon's post on the openwrt forums</a>.
This doesn't seem to work quite properly on system startup for me, but if you want to give it a try - <code>/etc/init.d/6tunnel enable</code> -
probably the worst that could happen is that 6tunnel times out connecting (because your ADSL/Cable link is not yet up). You might need to edit
the init script's line #6 from <code>ppp0</code> to <code>eth0</code> or something, whatever interface your public IPv4 address is found on.
